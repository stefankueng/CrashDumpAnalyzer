@using CrashDumpAnalyzer.Utilities
@model StatisticsData
@{
    ViewData["Title"] = "Crash Dump Analyzer - Statistics";
}

<div class="text-center">
<h1 class="display-4 title">@ViewData["Title"]</h1>
<div>
        @if (Model != null)
        {
            <table style="width:100%">
                <tr>
                    <th></th>
                    @foreach (var issueType in Model.IssueTypes)
                    {
                        <th>@issueType</th>
                    }
                </tr>
                <tr>
                    <td>Open callstacks</td>
                    @foreach (var issueType in Model.IssueTypes)
                    {
                        if (Model.OpenCallstacks.ContainsKey(issueType))
                        {
                            <td>@Model.OpenCallstacks[issueType]</td>
                        }
                        else
                        {
                            <td>0</td>
                        }
                    }
                </tr>
                <tr>
                    <td>Closed callstacks</td>
                    @foreach (var issueType in Model.IssueTypes)
                    {
                        if (Model.ClosedCallstacks.ContainsKey(issueType))
                        {
                            <td>@Model.ClosedCallstacks[issueType]</td>
                        }
                        else
                        {
                            <td>0</td>
                        }
                    }
                </tr>
                <tr>
                    <td>Open callstacks without assigned tickets</td>
                    @foreach (var issueType in Model.IssueTypes)
                    {
                        if (Model.OpenCallstacksWithoutTickets.ContainsKey(issueType))
                        {
                            <td>@Model.OpenCallstacksWithoutTickets[issueType]</td>
                        }
                        else
                        {
                            <td>0</td>
                        }
                    }
                </tr>
                <tr>
                    <td>Callstacks that were automatically assigned to existing ones</td>
                    @foreach (var issueType in Model.IssueTypes)
                    {
                        if (Model.CallstacksAssignedToExistingCallstacks.ContainsKey(issueType))
                        {
                            <td>@Model.CallstacksAssignedToExistingCallstacks[issueType]</td>
                        }
                        else
                        {
                            <td>0</td>
                        }
                    }
                </tr>
                <tr>
                    <td>Kept dump/log files</td>
                    @foreach (var issueType in Model.IssueTypes)
                    {
                        if (Model.NumberOfFiles.ContainsKey(issueType))
                        {
                            <td>@Model.NumberOfFiles[issueType] files, @SizeFormatter.SizeSuffix(@Model.TotalFileSize[issueType])</td>
                        }
                        else
                        {
                            <td>0</td>
                        }
                    }
                </tr>
            </table>
        }

    </div>
</div>
<div style="margin-top: 20px;text-align: center;">
    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteOldEntriesModal">
        Delete Old Entries
    </button>
</div>

<!-- Modal for Delete Old Entries -->
<div class="modal fade" id="deleteOldEntriesModal" tabindex="-1" aria-labelledby="deleteOldEntriesModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteOldEntriesModalLabel">Delete Old Entries</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="deleteModalCloseBtn"></button>
            </div>
            <div class="modal-body">
                <div id="deleteInputSection">
                    <p>Enter a version number to delete all entries with a lower version that do not have a ticket assigned.</p>
                    <div class="mb-3">
                        <label for="deleteVersionInput" class="form-label">Version Number:</label>
                        <input type="text" class="form-control" id="deleteVersionInput" placeholder="e.g., 1.2.3.4">
                    </div>
                </div>
                <div id="deleteProgressSection" style="display: none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span id="deleteProgressText">Preparing to delete entries...</span>
                            <span id="deleteProgressCounter">0 / 0</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="deleteProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                    </div>
                    <div id="deleteProgressDetails" class="small text-muted"></div>
                </div>
                <div id="deleteResultMessage" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="deleteCancelBtn">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteOldEntries()" id="deleteStartBtn">Delete</button>
                <button type="button" class="btn btn-primary" onclick="location.reload()" id="deleteReloadBtn" style="display: none;">Refresh Page</button>
            </div>
        </div>
    </div>
</div>

<partial name="_CallStackHelpers" />